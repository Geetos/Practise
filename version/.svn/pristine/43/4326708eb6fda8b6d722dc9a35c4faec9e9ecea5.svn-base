package com.jxtele.projectmanage.controller;

import com.jxtele.projectmanage.annotation.Permission;
import com.jxtele.projectmanage.controller.base.BaseController;
import com.jxtele.projectmanage.entity.PermissionType;
import com.jxtele.projectmanage.entity.XmpercentageItem;
import com.jxtele.projectmanage.service.XmpercentageItemService;
import com.jxtele.projectmanage.service.impl.AttachmentFileService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.thymeleaf.exceptions.TemplateInputException;

import java.util.List;
import java.util.Map;

@Controller
@RequestMapping("/xmpercentageItem")
public class XmpercentageItemController extends BaseController {
    @Autowired
    private XmpercentageItemService xmpercentageItemService;
    @Autowired
    AttachmentFileService attachmentFileService;
    @Value("${upload.root.folder}")
    public String locatFolder;
    private static final String qxurl = "xmpercentageItem/list";

    /**
     *增加项目提的分配数据（人员，分配金额，参与项目时间...）
     * @param recode
     * @return
     */
//    @RequestMapping(value="/add",method= RequestMethod.POST)
//    @Permission(url = qxurl,type = PermissionType.ADD)
//    public String add(@ModelAttribute XmpercentageItem recode,Model model){
//        int add = xmpercentageItemService.insert(recode);
//        if(add>0){
//            List<XmpercentageItem> xmlist = xmpercentageItemService.selectByPercentId(recode.getPercentageId());
//            model.addAttribute("percentageId", recode.getPercentageId());
//            model.addAttribute("xmlist", xmlist);
//        }
//        return "page/xmpercentageItem/list";
//    }
    /**
     * 查询提成详细数据列表
     */
    @RequestMapping(value="/list/{percentageId}",method=RequestMethod.GET)
    @Permission(url = qxurl,type = PermissionType.QUERY)
    public Object rcentageItemManageInfo(@PathVariable Integer percentageId, Model model){
        List<XmpercentageItem> xmlist = xmpercentageItemService.selectByPercentId(percentageId);
        model.addAttribute("percentageId", percentageId);
        model.addAttribute("xmlist", xmlist);
        return "page/xmpercentageItem/list";
    }

    /**
     * 删除某提成项目的分配某条详细数据
     * @param id
     * @return
     */
    @RequestMapping(value="/del/{id}",method=RequestMethod.GET)
    @Permission(url = qxurl,type = PermissionType.DEL)
    public Object del(@PathVariable Integer id){
        return xmpercentageItemService.deleteByPrimaryKey(id);
    }

    /**
     * 修改
     * @param record
     * @return
     */
    @RequestMapping(value="/edit",method=RequestMethod.POST)
    @Permission(url = qxurl,type = PermissionType.EDIT)
    public Object edit(@ModelAttribute XmpercentageItem record) throws TemplateInputException {
        return xmpercentageItemService.updateByPrimaryKeySelective(record);
    }

    /**
     * 上传附件
     * @param file
     * @param record
     * @return
     */
    @RequestMapping(value="/add" ,method = RequestMethod.POST)
    @ResponseBody
    @Permission(url = qxurl,type = PermissionType.ADD)
    public Object add(@ModelAttribute XmpercentageItem record, @RequestParam(value = "file",required = false) MultipartFile file, Model model){
        Map<String, Object> add = xmpercentageItemService.insert(record,  file , locatFolder);
//        if(!StringUtils.isEmpty(String.valueOf(add))){
//            List<XmpercentageItem> xmlist = xmpercentageItemService.selectByPercentId(record.getPercentageId());
//            model.addAttribute("percentageId", record.getPercentageId());
//            model.addAttribute("xmlist", xmlist);
//        }
        return add;
    }
}
